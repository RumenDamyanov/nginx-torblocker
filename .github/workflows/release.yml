name: Release Build and Publish

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to release (leave empty for latest tag)'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            GIT_TAG="${{ github.event.inputs.tag }}"
            echo "Using provided tag: $GIT_TAG"
          else
            # Get the latest tag
            GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$GIT_TAG" ]; then
              echo "Error: No tags found and no tag provided"
              exit 1
            fi
            echo "Using latest tag: $GIT_TAG"
          fi

          # Verify tag exists
          if ! git rev-parse "$GIT_TAG" >/dev/null 2>&1; then
            echo "Error: Tag '$GIT_TAG' does not exist"
            echo "Available tags:"
            git tag -l --sort=-version:refname | head -10
            exit 1
          fi

          # Check if it's a pre-release (contains alpha, beta, rc) or manual override
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          if [[ "$IS_PRERELEASE" != "true" ]] && [[ "$GIT_TAG" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="true"
            echo "Auto-detected pre-release from tag name: $GIT_TAG"
          fi

          # Remove 'v' prefix if present for version
          VERSION_NO_V="${GIT_TAG#v}"

          echo "version=$VERSION_NO_V" >> $GITHUB_OUTPUT
          echo "tag=$GIT_TAG" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Release version: $VERSION_NO_V"
          echo "Git tag: $GIT_TAG"
          echo "Is pre-release: $IS_PRERELEASE"

      - name: Checkout tag
        run: |
          echo "ğŸ“ Checking out tag ${{ steps.version.outputs.tag }}"
          git checkout "${{ steps.version.outputs.tag }}"
          echo "âœ… Checked out tag ${{ steps.version.outputs.tag }}"

  build-binaries:
    needs: determine-version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Latest 2 Ubuntu LTS versions with latest 2 stable Nginx versions
          - { ubuntu: "jammy", nginx: "1.26.3", arch: "amd64" }
          - { ubuntu: "jammy", nginx: "1.27.5", arch: "amd64" }
          - { ubuntu: "noble", nginx: "1.26.3", arch: "amd64" }
          - { ubuntu: "noble", nginx: "1.27.5", arch: "amd64" }
          - { ubuntu: "plucky", nginx: "1.26.3", arch: "amd64" }
          - { ubuntu: "plucky", nginx: "1.27.5", arch: "amd64" }
          # ARM64 builds for latest versions
          - { ubuntu: "jammy", nginx: "1.26.3", arch: "arm64" }
          - { ubuntu: "jammy", nginx: "1.27.5", arch: "arm64" }
          - { ubuntu: "noble", nginx: "1.26.3", arch: "arm64" }
          - { ubuntu: "noble", nginx: "1.27.5", arch: "arm64" }
          - { ubuntu: "plucky", nginx: "1.26.3", arch: "arm64" }
          - { ubuntu: "plucky", nginx: "1.27.5", arch: "arm64" }

    name: Build ${{ matrix.ubuntu }}-nginx${{ matrix.nginx }}-${{ matrix.arch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Checkout tag
        run: |
          echo "ğŸ“ Checking out tag ${{ needs.determine-version.outputs.tag }}"
          git checkout "${{ needs.determine-version.outputs.tag }}"
          echo "âœ… Checked out tag ${{ needs.determine-version.outputs.tag }}"

      - name: Set up QEMU (for cross-compilation)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in container
        run: |
          # Run build in appropriate container
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            PLATFORM="linux/arm64"
          else
            PLATFORM="linux/amd64"
          fi

          # Create output directory
          mkdir -p output

          docker run --rm --platform="$PLATFORM" \
            -v "$PWD:/workspace" \
            -v "$PWD/output:/output" \
            ubuntu:${{ matrix.ubuntu }} \
            bash -c "
              set -e

              # Install dependencies
              apt-get update
              apt-get install -y build-essential wget gcc libpcre3-dev zlib1g-dev file

              # Download and extract Nginx source
              NGINX_VERSION='${{ matrix.nginx }}'
              SRC_DIR='/workspace/src'
              BUILD_DIR='/tmp/nginx-build'

              mkdir -p \"\$BUILD_DIR\"
              cd \"\$BUILD_DIR\"

              echo \"Downloading Nginx \$NGINX_VERSION...\"
              wget -nv \"https://nginx.org/download/nginx-\$NGINX_VERSION.tar.gz\"
              tar xzf \"nginx-\$NGINX_VERSION.tar.gz\"
              cd \"nginx-\$NGINX_VERSION\"

              echo \"Configuring with torblocker module...\"
              ./configure --add-dynamic-module=\"\$SRC_DIR\"

              echo \"Building modules...\"
              make modules

              echo \"Checking built module...\"
              file objs/ngx_http_torblocker_module.so

              # Copy to output (mounted volume)
              echo \"Copying module to output...\"
              cp objs/ngx_http_torblocker_module.so /output/

              echo \"Build completed successfully!\"
            "

      - name: Package binary
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          PACKAGE_NAME="nginx-torblocker-${VERSION}-${{ matrix.ubuntu }}-nginx${{ matrix.nginx }}-${{ matrix.arch }}"

          mkdir -p "packages/$PACKAGE_NAME"

          # Create output directory if it doesn't exist
          mkdir -p output

          # Copy built module from output directory
          if [ ! -f "output/ngx_http_torblocker_module.so" ]; then
            echo "Error: Module not found in output directory"
            ls -la output/
            exit 1
          fi

          cp "output/ngx_http_torblocker_module.so" "packages/$PACKAGE_NAME/"

          # Create installation script
          cat > "packages/$PACKAGE_NAME/install.sh" << 'EOF'
          #!/bin/bash
          # Nginx TorBlocker Module Installation Script

          set -e

          NGINX_VERSION="${{ matrix.nginx }}"
          MODULE_DIR="/usr/lib/nginx/modules"
          BACKUP_DIR="/usr/lib/nginx/modules/backup"

          echo "Installing nginx-torblocker module for Nginx $NGINX_VERSION..."

          # Check if nginx is installed and version matches
          if ! command -v nginx >/dev/null 2>&1; then
              echo "Error: Nginx is not installed"
              exit 1
          fi

          INSTALLED_VERSION=$(nginx -v 2>&1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          if [ "$INSTALLED_VERSION" != "$NGINX_VERSION" ]; then
              echo "Warning: Installed Nginx version ($INSTALLED_VERSION) doesn't match module version ($NGINX_VERSION)"
              echo "This may cause compatibility issues."
              read -p "Continue anyway? (y/N): " -n 1 -r
              echo
              if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                  exit 1
              fi
          fi

          # Create backup if module already exists
          if [ -f "$MODULE_DIR/ngx_http_torblocker_module.so" ]; then
              echo "Backing up existing module..."
              mkdir -p "$BACKUP_DIR"
              cp "$MODULE_DIR/ngx_http_torblocker_module.so" "$BACKUP_DIR/ngx_http_torblocker_module.so.$(date +%Y%m%d_%H%M%S)"
          fi

          # Install module
          echo "Installing module to $MODULE_DIR..."
          sudo mkdir -p "$MODULE_DIR"
          sudo cp ngx_http_torblocker_module.so "$MODULE_DIR/"
          sudo chmod 644 "$MODULE_DIR/ngx_http_torblocker_module.so"

          echo "Module installed successfully!"
          echo ""
          echo "To use the module, add the following line to the top of your nginx.conf:"
          echo "load_module modules/ngx_http_torblocker_module.so;"
          echo ""
          echo "Then configure the module in your http block:"
          echo "http {"
          echo "    torblock on;"
          echo "}"
          echo ""
          echo "Test your configuration with: sudo nginx -t"
          echo "Reload nginx with: sudo systemctl reload nginx"
          EOF

          chmod +x "packages/$PACKAGE_NAME/install.sh"

          # Create README
          cat > "packages/$PACKAGE_NAME/README.md" << EOF
          # Nginx TorBlocker Module v${{ needs.determine-version.outputs.version }}

          **Target Platform:** Ubuntu ${{ matrix.ubuntu }} (${{ matrix.arch }})
          **Nginx Version:** ${{ matrix.nginx }}
          **Module Version:** ${{ needs.determine-version.outputs.version }}

          ## Installation

          1. Run the installation script:
             \`\`\`bash
             sudo ./install.sh
             \`\`\`

          2. Add to your nginx.conf:
             \`\`\`nginx
             load_module modules/ngx_http_torblocker_module.so;
             \`\`\`

          3. Configure the module:
             \`\`\`nginx
             http {
                 torblock on;
             }
             \`\`\`

          4. Test and reload:
             \`\`\`bash
             sudo nginx -t
             sudo systemctl reload nginx
             \`\`\`

          ## Documentation

          Complete documentation is available at:
          https://github.com/RumenDamyanov/nginx-torblocker/wiki

          ## Support

          - Report issues: https://github.com/RumenDamyanov/nginx-torblocker/issues
          - Community discussions: https://github.com/RumenDamyanov/nginx-torblocker/discussions
          EOF

          # Create archive
          cd packages
          tar czf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME"

          echo "Package created: packages/$PACKAGE_NAME.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nginx-torblocker-${{ matrix.ubuntu }}-nginx${{ matrix.nginx }}-${{ matrix.arch }}
          path: packages/*.tar.gz
          retention-days: 30

  build-debian-packages:
    needs: determine-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu: [jammy, noble, plucky]
        arch: [amd64, arm64]
        nginx: [1.26.3, 1.27.5]

    name: Debian Package ${{ matrix.ubuntu }}-${{ matrix.arch }}-nginx${{ matrix.nginx }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Checkout tag
        run: |
          echo "ğŸ“ Checking out tag ${{ needs.determine-version.outputs.tag }}"
          git checkout "${{ needs.determine-version.outputs.tag }}"
          echo "âœ… Checked out tag ${{ needs.determine-version.outputs.tag }}"

      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Build Debian package
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          NGINX_VERSION="${{ matrix.nginx }}"

          # Update version in debian/changelog
          sed -i "1s/.*/nginx-torblocker ($VERSION-1) ${{ matrix.ubuntu }}; urgency=medium/" debian/changelog

          # Remove nginx-dev dependency for release builds (we build from source)
          sed -i 's/nginx-dev, //g' debian/control

          # Build package in container
          docker run --rm --platform=linux/${{ matrix.arch }} \
            -v "$PWD:/workspace" \
            -w /workspace \
            ubuntu:${{ matrix.ubuntu }} \
            bash -c "
              set -e
              apt-get update
              apt-get install -y build-essential devscripts debhelper wget libpcre2-dev zlib1g-dev libssl-dev pkg-config

              # Download and setup Nginx source for building
              mkdir -p /project/headers
              cd /project/headers
              wget -nv https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
              tar xzf nginx-${NGINX_VERSION}.tar.gz

              # Configure nginx to generate proper headers
              cd nginx-${NGINX_VERSION}
              ./configure --with-compat

              # Return to workspace and build package
              cd /workspace

              # Override the NGINX_VERSION variable for debian/rules
              export NGINX_VERSION=${NGINX_VERSION}              # Build the package
              dpkg-buildpackage -us -uc -b --build-profiles=nocheck

              # Move .deb files to packages directory
              mkdir -p packages/debian
              find .. -maxdepth 1 -name '*.deb' -exec mv {} packages/debian/ \;

              echo 'Built packages:'
              ls -la packages/debian/ || echo 'No packages found'
            "

      - name: Upload Debian packages
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages-${{ matrix.ubuntu }}-${{ matrix.arch }}-nginx${{ matrix.nginx }}
          path: packages/debian/*.deb
          retention-days: 30

  create-release:
    needs: [determine-version, build-binaries, build-debian-packages]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Checkout tag
        run: |
          echo "ğŸ“ Checking out tag ${{ needs.determine-version.outputs.tag }}"
          git checkout "${{ needs.determine-version.outputs.tag }}"
          echo "âœ… Checked out tag ${{ needs.determine-version.outputs.tag }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Organize release assets
        run: |
          mkdir -p release-assets

          # Copy binary packages
          find release-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;

          # Copy Debian packages
          find release-artifacts -name "*.deb" -exec cp {} release-assets/ \;

          # Create checksums
          cd release-assets
          sha256sum * > SHA256SUMS

          echo "Release assets:"
          ls -la

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          cat > release_notes.md << EOF
          ## Nginx TorBlocker v$VERSION

          ### ğŸ“¦ Binary Packages

          Pre-compiled modules for popular Ubuntu versions and Nginx releases:

          #### Ubuntu 22.04 LTS (Jammy)
          - **AMD64**: nginx-torblocker-$VERSION-jammy-nginx1.26.3-amd64.tar.gz
          - **AMD64**: nginx-torblocker-$VERSION-jammy-nginx1.27.5-amd64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-jammy-nginx1.26.3-arm64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-jammy-nginx1.27.5-arm64.tar.gz

          #### Ubuntu 24.04 LTS (Noble)
          - **AMD64**: nginx-torblocker-$VERSION-noble-nginx1.26.3-amd64.tar.gz
          - **AMD64**: nginx-torblocker-$VERSION-noble-nginx1.27.5-amd64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-noble-nginx1.26.3-arm64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-noble-nginx1.27.5-arm64.tar.gz

          #### Ubuntu 25.04 (Plucky)
          - **AMD64**: nginx-torblocker-$VERSION-plucky-nginx1.26.3-amd64.tar.gz
          - **AMD64**: nginx-torblocker-$VERSION-plucky-nginx1.27.5-amd64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-plucky-nginx1.26.3-arm64.tar.gz
          - **ARM64**: nginx-torblocker-$VERSION-plucky-nginx1.27.5-arm64.tar.gz

          ### ğŸ§ Debian Packages (.deb)

          Native .deb packages for Ubuntu systems (install with \`dpkg -i\`).

          ### ğŸ“‹ Installation

          1. **Download** the appropriate package for your system
          2. **Extract**: \`tar xzf nginx-torblocker-*.tar.gz\`
          3. **Install**: \`sudo ./install.sh\`
          4. **Configure**: Add \`load_module modules/ngx_http_torblocker_module.so;\` to nginx.conf

          ### ğŸ“– Documentation

          - **[Installation Guide](https://github.com/RumenDamyanov/nginx-torblocker/wiki/Installation-Guide)**
          - **[Configuration Reference](https://github.com/RumenDamyanov/nginx-torblocker/wiki/Configuration-Reference)**
          - **[Complete Wiki](https://github.com/RumenDamyanov/nginx-torblocker/wiki)**

          ### ğŸ” Verification

          Verify package integrity with SHA256SUMS:
          \`\`\`bash
          sha256sum -c SHA256SUMS
          \`\`\`

          ### ğŸ’¬ Support

          - **Issues**: [GitHub Issues](https://github.com/RumenDamyanov/nginx-torblocker/issues)
          - **Discussions**: [GitHub Discussions](https://github.com/RumenDamyanov/nginx-torblocker/discussions)
          - **Documentation**: [Project Wiki](https://github.com/RumenDamyanov/nginx-torblocker/wiki)
          EOF

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine-version.outputs.tag }}
          name: "nginx-torblocker ${{ needs.determine-version.outputs.version }}"
          body: ${{ steps.release_notes.outputs.release_notes }}
          prerelease: ${{ needs.determine-version.outputs.is_prerelease }}
          files: |
            release-assets/*
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "ğŸ‰ Release ${{ needs.determine-version.outputs.tag }} created successfully!"
          echo "ğŸ“‹ Version: ${{ needs.determine-version.outputs.version }}"
          echo "ğŸ·ï¸ Tag: ${{ needs.determine-version.outputs.tag }}"
          echo "ğŸ”– Pre-release: ${{ needs.determine-version.outputs.is_prerelease }}"
