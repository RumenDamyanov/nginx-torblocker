#!/usr/bin/make -f

# Use system nginx-dev package headers instead of downloading source
DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
BUILDDIR = obj-$(DEB_HOST_MULTIARCH)

%:
	dh $@

override_dh_auto_build:
	mkdir -p $(BUILDDIR)

	# Check if we're building with downloaded nginx source (release workflow)
	# or system nginx-dev headers (PPA workflow)
	if [ -n "$(NGINX_VERSION)" ] && [ -d "/project/headers/nginx-$(NGINX_VERSION)" ]; then \
		echo "Building with downloaded nginx source (version $(NGINX_VERSION))..."; \
		cd /project/headers/nginx-$(NGINX_VERSION) && \
		gcc -c -fPIC \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/core \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/event \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/event/modules \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/os/unix \
			-I/project/headers/nginx-$(NGINX_VERSION)/objs \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/http \
			-I/project/headers/nginx-$(NGINX_VERSION)/src/http/modules \
			$$(pkg-config --cflags libpcre2-8) \
			-o /workspace/$(BUILDDIR)/ngx_http_torblocker_module.o \
			/workspace/src/ngx_http_torblocker_module.c; \
	else \
		echo "Building with system nginx-dev using configure..."; \
		NGINX_SRC="/usr/share/nginx/src"; \
		MODULE_PATH="$$(pwd)/src"; \
		BUILD_DIR="$$(pwd)/$(BUILDDIR)"; \
		cd $$NGINX_SRC && \
		./configure --add-dynamic-module=$$MODULE_PATH --with-compat && \
		make modules && \
		cp objs/ngx_http_torblocker_module.so $$BUILD_DIR/; \
	fi

	# For release workflow, create the shared library from the object file
	if [ -n "$(NGINX_VERSION)" ] && [ -d "/project/headers/nginx-$(NGINX_VERSION)" ]; then \
		gcc -shared \
			-o $(BUILDDIR)/ngx_http_torblocker_module.so \
			$(BUILDDIR)/ngx_http_torblocker_module.o; \
	fi

	echo "Build completed. Module location:"
	ls -l $(BUILDDIR)/ngx_http_torblocker_module.so

override_dh_auto_clean:
	find $(BUILDDIR) -mindepth 1 -delete 2>/dev/null || true
	rm -rf $(BUILDDIR)

override_dh_auto_install:
	echo "Installing nginx module..."
	install -D -m 644 $(BUILDDIR)/ngx_http_torblocker_module.so \
		debian/nginx-torblocker/usr/lib/nginx/modules/ngx_http_torblocker_module.so
